SELECT
        ITE.NUNOTA
        , ITE.SEQUENCIA
        , CAB.NUMNOTA
        , CAB.CODEMP
        , EMP.CODEMPMATRIZ
        , CAB.DTENTSAI
        , CAB.DTNEG
        , CAB.TIPMOV
        , CAB.CODPARC
        , PAR.RAZAOSOCIAL
        , ITE.CODPROD
        , PRO.DESCRPROD
        , PRO.USOPROD
        , ITE.CODCFO
        , ITE.CODTRIB
        , ITE.QTDNEG
        , ITE.VLRUNIT
        , ITE.VLRTOT
        , ITE.BASEICMS
        , ITE.VLRICMS
        , ITE.BASESUBSTIT
        , ITE.VLRSUBST
        , ITE.BASESUBSTITANT
        , ITE.VLRSUBSTANT
        , CAB.CHAVENFE
		, (SELECT SUM(I.QTDNEG) FROM TGFCAB C INNER JOIN TGFITE I ON C.NUNOTA = I.NUNOTA WHERE I.CODPROD = ITE.CODPROD AND I.CODCFO IN ('2401', '2403')
					AND C.TIPMOV IN ('C') AND C.STATUSNOTA = 'L' AND C.CODEMP = CAB.CODEMP AND I.CODTRIB IN (10,30,60,70) AND C.DTENTSAI <= CAB.DTNEG AND CAB.CODTIPOPER NOT IN (213,215,216,217,219)) AS QUANTIDADE_COMPRA

		, (SELECT SUM(I.VLRSUBST) FROM TGFCAB C INNER JOIN TGFITE I ON C.NUNOTA = I.NUNOTA WHERE I.CODPROD = ITE.CODPROD AND I.CODCFO IN ('2401', '2403')
					AND C.TIPMOV IN ('C') AND C.STATUSNOTA = 'L' AND C.CODEMP = CAB.CODEMP AND I.CODTRIB IN (10,30,70) AND C.DTENTSAI <= CAB.DTNEG AND CAB.CODTIPOPER NOT IN (213,215,216,217,219)) AS VALOR_ST_DA_COMPRA

		, (SELECT SUM(I.VLRSUBST)/SUM(I.QTDNEG) FROM TGFCAB C INNER JOIN TGFITE I ON C.NUNOTA = I.NUNOTA WHERE I.CODPROD = ITE.CODPROD AND I.CODCFO IN ('2401', '2403')
                    AND C.TIPMOV IN ('C') AND C.STATUSNOTA = 'L' AND C.CODEMP = CAB.CODEMP AND I.CODTRIB IN (10,30,70) AND C.DTENTSAI <= CAB.DTNEG AND CAB.CODTIPOPER NOT IN (213,215,216,217,219))*ITE.QTDNEG AS ST_MEDIO_DA_COMPRA

		, (SELECT SUM(I.VLRICMS) FROM TGFCAB C INNER JOIN TGFITE I ON C.NUNOTA = I.NUNOTA WHERE I.CODPROD = ITE.CODPROD AND I.CODCFO IN ('2401', '2403')
					AND C.TIPMOV IN ('C') AND C.STATUSNOTA = 'L' AND C.CODEMP = CAB.CODEMP AND I.CODTRIB IN (10,30,60,70) AND C.DTENTSAI <= CAB.DTNEG AND CAB.CODTIPOPER NOT IN (213,215,216,217,219)) AS VALOR_ICMSOP_DA_COMPRA

		, (SELECT SUM(I.VLRICMS)/SUM(I.QTDNEG) FROM TGFCAB C INNER JOIN TGFITE I ON C.NUNOTA = I.NUNOTA WHERE I.CODPROD = ITE.CODPROD AND I.CODCFO IN ('2401', '2403')
					AND C.TIPMOV IN ('C') AND C.STATUSNOTA = 'L' AND C.CODEMP = CAB.CODEMP AND I.CODTRIB IN (10,30,60,70) AND C.DTENTSAI <= CAB.DTNEG AND CAB.CODTIPOPER NOT IN (213,215,216,217,219))*ITE.QTDNEG AS ICMSOP_MEDIO_DA_COMPRA

    FROM TGFCAB CAB
    INNER JOIN TGFITE ITE ON ITE.NUNOTA = CAB.NUNOTA
    INNER JOIN TGFPRO PRO ON PRO.CODPROD = ITE.CODPROD
    INNER JOIN TGFPAR PAR ON PAR.CODPARC = CAB.CODPARC
    INNER JOIN TSIEMP EMP ON EMP.CODEMP = CAB.CODEMP

    WHERE CAB.TIPMOV IN ('V')
    AND CAB.STATUSNOTA = 'L'
    AND CAB.STATUSNFE ='A'
    AND ITE.SEQUENCIA > 0
    AND ITE.CODCFO IN (5927,6927,6101,6102,6107,6108,6116,6117,6202,6403,6404,6411,6655,6656,6949)